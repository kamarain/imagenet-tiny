#!/bin/bash
# In this file you may set the variables corresponding to your
# ImageNet-tiny experiments with caffe, but note that at the
# end we also generate certain variables and files so better check
# them if any errors occure

# Main variables affecting the network
RUNNAME="ImageNet-tiny-16x16-sRGB"
RUNCOUNT="" # -1, -2 etc if RUNNAME is the same
TEMPWORK=./TEMPWORK
TINYDIR=/home/kamarain/Data/ImageNet-tiny-16x16-sRGB-8bit
SOLVERTEMPLATE="solvers/imagenet-tiny-solver-1" # adds .prototxt.tmpl
NETWORKTEMPLATE="networks/net-2" # adds .prototxt.tmpl
RESUMEITER="10000" # for resume_training (check TEMPWORK dir)

CONVERT_IMAGESET_ARGS="--shuffle" # e.g. -gray -shuffle
USEGPU=1;
USESCRIPT=1; # in slurm systems set to 0

# Major paths
if [ $USEGPU -eq 1 ]; then
    # Set CUDA paths correctly
    export CUDA_HOME=/usr/local/cuda 
    export LD_LIBRARY_PATH=${CUDA_HOME}/lib64 
    PATH=${CUDA_HOME}/bin:${PATH} 
    export PATH 

    CAFFEDIR=/home/kamarain/Work/ext/caffe
else
    CAFFEDIR=/home/kamarain/Work/ext/caffe
fi;

# Dependant paths
TOOLS=${CAFFEDIR}/build/tools
DATA=${CAFFEDIR}/data/ilsvrc12-tiny
TRAIN_DATA_ROOT=${TINYDIR}/ILSVR2014/CLS-LOC/ILSVRC2012_img_train/
VAL_DATA_ROOT=${TINYDIR}/ILSVR2014/CLS-LOC/ILSVRC2012_img_val/

# These are generated by the create-imagenet-tiny.sh
TRAINDB=${TEMPWORK}/${RUNNAME}${RUNCOUNT}_train_leveldb
VALDB=${TEMPWORK}/${RUNNAME}${RUNCOUNT}_val_leveldb
echo "DEFS: Generated by create_imagenet-tiny.sh:"
echo "DEFS:    TRAINDB=$TRAINDB"
echo "DEFS:    VALBD=$VALDB"

# This is generated by make-mean-imagenet-tiny.sh
MEANFILE=${TEMPWORK}/${RUNNAME}_mean.binaryproto
echo "DEFS: Generated by make_mean_imagenet-tiny.sh:"
echo "DEFS:    MEANFILE=$MEANFILE"

# These are generated by train
SNAPSHOTPREFIX="$TEMPWORK/caffe_${RUNNAME}${RUNCOUNT}-"`basename $NETWORKTEMPLATE`
echo "DEFS: Generated by train/resume_imagenet-tiny.sh:"
echo "DEFS:    SNAPSHOTPREFIX=$SNAPSHOTPREFIX"

#
SOLVERNAME="$TEMPWORK/${RUNNAME}${RUNCOUNT}-"`basename $SOLVERTEMPLATE`".prototxt"
NETWORKNAME="$TEMPWORK/${RUNNAME}${RUNCOUNT}-"`basename $NETWORKTEMPLATE`".prototxt"
TRAINLOG="$TEMPWORK/LOG_caffe_${RUNNAME}${RUNCOUNT}-"`basename $NETWORKTEMPLATE`".txt"
echo "DEFS: Files generated and used by train/resume_imagenet-tiny.sh"
echo "DEFS:    SOLVERNAME=$SOLVERNAME"
echo "DEFS:    NETWORKNAME=$NETWORKNAME"
echo "DEFS:    TRAINLOG=$TRAINLOG (not used in slurm runs)"

# Make solver and network prototxt files based on definitions
sed -e "s|@NETWORK@|$NETWORKNAME|g" -e "s|@SNAPSHOTPREFIX@|$SNAPSHOTPREFIX|g" ${SOLVERTEMPLATE}.prototxt.tmpl > "$SOLVERNAME";
sed -e "s|@TRAINDB@|$TRAINDB|g" -e "s|@VALDB@|$VALDB|g" -e "s|@MEANFILE@|$MEANFILE|g" ${NETWORKTEMPLATE}.prototxt.tmpl > "${NETWORKNAME}";


